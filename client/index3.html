<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- Add Prism.js CSS and JS -->
  </head>
  <body>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <style>
      #messageInput {
        border-radius: 10px !important;
      }
      #main {
        padding-top: 0px;
      }
      #content {
        margin-bottom: 0px !important;
      }
      .wp-image-1053 {
        width: 80% !important;
      }
      /* Add these styles to match kr2.html */
      .fusion-builder-row {
        max-width: 100vw !important;
        margin-left: 0px !important;
        margin-right: 0px !important;
      }

      .fusion-builder-row-1 {
        padding-top: 10px !important;
        padding-bottom: 10px !important;
      }

      .fusion-page-title-bar {
        display: none;
      }

      #main {
        padding: 0px !important;
        width: 100% !important;
      }

      .fusion-column-wrapper {
        margin: 0px !important;
      }

      .fusion-layout-column {
        margin: 0px !important;
      }

      /* Add these styles for better code display */
      pre {
        background: #1f2937 !important;
        border-radius: 0.5rem;
        padding: 1rem !important;
        margin: 0 !important;
      }

      code {
        font-family: "Fira Code", monospace !important;
        font-size: 0.875rem !important;
        line-height: 1.5 !important;
      }
    </style>
    <div class="bg-gray-900">
      <script src="https://cdn.tailwindcss.com"></script>
      <div class="p-4">
        <div
          class="max-w-3xl mx-auto mb-6 bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-2xl p-8 border border-gray-700/50"
          id="imageUpload"
        >
          <div class="text-center mb-8">
            <h2
              class="text-3xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500"
            >
              UI to Code Converter
            </h2>
            <p class="text-gray-400 text-lg font-light">
              Transform your UI designs into clean, production-ready code with
              AI
            </p>
          </div>

          <div
            class="border-2 border-dashed border-gray-600/50 rounded-xl p-10 text-center hover:border-blue-500/70 transition-all duration-300 bg-gray-800/50 backdrop-blur-sm group"
            id="uploadContainer"
          >
            <input type="file" id="fileInput" class="hidden" accept="image/*" />
            <label
              for="fileInput"
              class="cursor-pointer block group-hover:scale-105 transition-transform duration-300"
            >
              <div
                class="bg-gray-700/50 rounded-full p-6 w-24 h-24 mx-auto mb-6 group-hover:bg-blue-500/20 transition-colors"
              >
                <svg
                  class="w-full h-full text-gray-400 group-hover:text-blue-400 transition-colors"
                  stroke="currentColor"
                  fill="none"
                  viewBox="0 0 48 48"
                >
                  <path
                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </div>
              <p class="text-lg font-medium text-gray-300 mb-2">
                Drop your UI design here
              </p>
              <p class="text-sm text-gray-500">
                Supports PNG, JPG, GIF â€¢ Max 10MB
              </p>
            </label>
          </div>

          <!-- New container for side-by-side layout -->
          <div id="previewContainer" class="hidden">
            <div class="flex gap-6 items-center mb-8">
              <div class="w-1/2">
                <img
                  id="imagePreview"
                  class="w-full h-64 object-contain rounded-lg shadow-xl bg-gray-800/50 p-4"
                />
              </div>
              <div class="w-1/2">
                <div
                  class="border-2 border-dashed border-gray-600/50 rounded-xl p-8 text-center hover:border-blue-500/70 transition-all duration-300 bg-gray-800/50 backdrop-blur-sm group"
                >
                  <label
                    for="fileInput"
                    class="cursor-pointer block group-hover:scale-105 transition-transform duration-300"
                  >
                    <div
                      class="bg-gray-700/50 rounded-full p-4 w-16 h-16 mx-auto mb-4 group-hover:bg-blue-500/20 transition-colors"
                    >
                      <svg
                        class="w-full h-full text-gray-400 group-hover:text-blue-400 transition-colors"
                        stroke="currentColor"
                        fill="none"
                        viewBox="0 0 48 48"
                      >
                        <path
                          d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    </div>
                    <p class="text-base font-medium text-gray-300">
                      Choose different image
                    </p>
                  </label>
                </div>
              </div>
            </div>
            <div class="flex justify-center">
              <button
                id="analyzeButton"
                class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-semibold py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-xl disabled:opacity-50 disabled:hover:scale-100"
              >
                <span class="flex items-center gap-2">
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 10V3L4 14h7v7l9-11h-7z"
                    />
                  </svg>
                  Convert to Code
                </span>
              </button>
            </div>
          </div>
        </div>

        <div class="hidden" id="chatInterface">
          <div class="flex gap-6">
            <div
              class="w-1/4 bg-gray-800 rounded-lg shadow-lg p-4 h-[calc(100vh-7rem)] flex flex-col"
            >
              <h3 class="text-lg font-semibold mb-3 !text-gray-100">History</h3>
              <div
                class="space-y-2 overflow-y-auto flex-1 scrollbar-custom"
                id="imageHistory"
              >
                <!-- Image history items will be added here -->
              </div>
            </div>

            <div class="w-3/4 space-y-3">
              <div
                class="bg-gray-800 rounded-lg shadow-lg p-6 h-[calc(100vh-12rem)] overflow-y-auto scrollbar-custom"
              >
                <div class="flex justify-between items-center">
                  <div class="">
                    <h3 class="text-lg font-semibold mb-4 !text-gray-100">
                      Output
                    </h3>
                  </div>
                  <div class="flex gap-2">
                    <button
                      id="previewButton"
                      class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg transition-colors"
                    >
                      Preview
                    </button>
                    <button
                      id="codeButton"
                      class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg transition-colors"
                    >
                      Code
                    </button>
                    <button
                      id="copyButton"
                      class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg transition-colors flex items-center gap-2"
                      title="Copy code"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                        />
                      </svg>
                      Copy
                    </button>
                    <button
                      id="newTabButton"
                      class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg transition-colors"
                    >
                      Open in new tab
                    </button>
                  </div>
                </div>
                <div
                  id="outputContent"
                  class="prose prose-invert max-w-none max-h-[calc(100vh-16rem)] overflow-y-auto scrollbar-custom"
                >
                  <div id="previewContent" class="hidden">
                    <!-- Preview iframe will be inserted here -->
                  </div>
                  <div id="codeContent" class="hidden">
                    <pre><code class="language-html"></code></pre>
                  </div>
                </div>
              </div>

              <div class="!bg-gray-800 !rounded-lg !shadow-lg p-4 py-2">
                <div class="flex items-center gap-3">
                  <input
                    type="text"
                    id="messageInput"
                    class="flex-1 !bg-gray-700 border-gray-600 !text-gray-100 !rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400"
                    placeholder="Type your message here..."
                  />
                  <button
                    id="newImageButton"
                    class="bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-full w-10 h-10 flex items-center justify-center transition-colors"
                    title="Upload new image"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-6 w-6"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                      />
                    </svg>
                  </button>
                  <button
                    id="sendButton"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors"
                  >
                    Send
                  </button>
                  <input
                    type="file"
                    id="newFileInput"
                    class="hidden"
                    accept="image/*"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Added SEO-friendly content section -->
      <div class="max-w-6xl mx-auto py-16 px-4" id="contentSection">
        <div class="space-y-16">
          <!-- How It Works Section -->
          <section class="space-y-6">
            <h2
              class="text-3xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500"
            >
              How Our UI to Code Converter Works
            </h2>
            <div class="grid md:grid-cols-3 gap-8">
              <div
                class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50"
              >
                <div class="text-blue-400 text-3xl font-bold mb-2">01</div>
                <h3 class="!text-gray-200 text-xl font-semibold mb-3">
                  Upload Design
                </h3>
                <p class="text-gray-400 text-lg leading-relaxed">
                  Simply upload your UI design image in any common format (PNG,
                  JPG, or GIF).
                </p>
              </div>
              <div
                class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50"
              >
                <div class="text-blue-400 text-3xl font-bold mb-2">02</div>
                <h3 class="!text-gray-200 text-xl font-semibold mb-3">
                  AI Analysis
                </h3>
                <p class="text-gray-400 text-lg leading-relaxed">
                  Our advanced AI analyzes your design and understands its
                  structure and components.
                </p>
              </div>
              <div
                class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50"
              >
                <div class="text-blue-400 text-3xl font-bold mb-2">03</div>
                <h3 class="!text-gray-200 text-xl font-semibold mb-3">
                  Generate Code
                </h3>
                <p class="text-gray-400 text-lg leading-relaxed">
                  Receive clean, production-ready HTML and CSS code that matches
                  your design perfectly.
                </p>
              </div>
            </div>
          </section>

          <!-- Features Section -->
          <section class="space-y-6">
            <h2
              class="text-3xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500"
            >
              Key Features
            </h2>
            <div class="grid md:grid-cols-2 gap-8">
              <div class="flex gap-6">
                <div class="bg-blue-500/10 p-4 rounded-lg h-fit">
                  <svg
                    class="w-8 h-8 text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 10V3L4 14h7v7l9-11h-7z"
                    />
                  </svg>
                </div>
                <div>
                  <h3 class="!text-gray-200 text-xl font-semibold mb-3">
                    Instant Code Generation
                  </h3>
                  <p class="text-gray-400 text-lg leading-relaxed">
                    Transform your designs into code within seconds, saving
                    hours of manual coding.
                  </p>
                </div>
              </div>
              <div class="flex gap-6">
                <div class="bg-blue-500/10 p-4 rounded-lg h-fit">
                  <svg
                    class="w-8 h-8 text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
                    />
                  </svg>
                </div>
                <div>
                  <h3 class="!text-gray-200 text-xl font-semibold mb-3">
                    Clean, Optimized Code
                  </h3>
                  <p class="text-gray-400 text-lg leading-relaxed">
                    Get well-structured, semantic HTML and efficient CSS that
                    follows best practices.
                  </p>
                </div>
              </div>
              <div class="flex gap-6">
                <div class="bg-blue-500/10 p-4 rounded-lg h-fit">
                  <svg
                    class="w-8 h-8 text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                    />
                  </svg>
                </div>
                <div>
                  <h3 class="!text-gray-200 text-xl font-semibold mb-3">
                    Pixel-Perfect Accuracy
                  </h3>
                  <p class="text-gray-400 text-lg leading-relaxed">
                    Our AI ensures your code matches your design with precise
                    measurements and styling.
                  </p>
                </div>
              </div>
              <div class="flex gap-6">
                <div class="bg-blue-500/10 p-4 rounded-lg h-fit">
                  <svg
                    class="w-8 h-8 text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"
                    />
                  </svg>
                </div>
                <div>
                  <h3 class="!text-gray-200 text-xl font-semibold mb-3">
                    Responsive by Default
                  </h3>
                  <p class="text-gray-400 text-lg leading-relaxed">
                    Generated code is mobile-friendly and works seamlessly
                    across all devices.
                  </p>
                </div>
              </div>
            </div>
          </section>

          <!-- Why Choose Us Section -->
          <section class="space-y-6">
            <h2
              class="text-3xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500"
            >
              Why Choose Our UI to Code Converter
            </h2>
            <div
              class="bg-gray-800/50 p-8 rounded-xl border border-gray-700/50 space-y-6"
            >
              <p class="text-gray-300 text-lg leading-relaxed">
                Our AI-powered UI to Code Converter stands out from traditional
                solutions by offering unmatched accuracy, speed, and code
                quality. Built with the latest machine learning technologies, it
                understands design patterns and components at a deeper level,
                producing code that's not just accurate but also maintainable
                and scalable.
              </p>
              <ul class="space-y-4 text-gray-400">
                <li class="flex items-center gap-3">
                  <svg
                    class="w-6 h-6 text-blue-400 flex-shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                  <span class="text-lg"
                    >Supports modern frameworks and libraries</span
                  >
                </li>
                <li class="flex items-center gap-3">
                  <svg
                    class="w-6 h-6 text-blue-400 flex-shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                  <span class="text-lg">Regular updates and improvements</span>
                </li>
                <li class="flex items-center gap-3">
                  <svg
                    class="w-6 h-6 text-blue-400 flex-shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                  <span class="text-lg">24/7 AI-powered assistance</span>
                </li>
              </ul>
            </div>
          </section>
        </div>
      </div>

      <script>
        // Initially disable the send button and input
        document.getElementById("sendButton").disabled = true;
        document.getElementById("messageInput").disabled = true;

        document
          .getElementById("analyzeButton")
          .addEventListener("click", async function () {
            const fileInput = document.getElementById("fileInput");
            if (fileInput.files && fileInput.files[0]) {
              // Hide content section
              document.getElementById("contentSection").classList.add("hidden");

              // Show loading state and chat interface
              document.getElementById("imageUpload").classList.add("hidden");
              document
                .getElementById("chatInterface")
                .classList.remove("hidden");

              // Add the uploaded image to history immediately
              const reader = new FileReader();
              reader.onload = function (e) {
                const historyDiv = document.getElementById("imageHistory");
                const newImage = document.createElement("div");
                newImage.className =
                  "border border-gray-700 rounded-lg p-2 hover:bg-gray-700 cursor-pointer transition-colors mb-3";
                newImage.innerHTML = `
                <img src="${e.target.result}" alt="Uploaded image" class="w-full h-32 object-cover rounded-lg mb-2">
                <p class="text-sm text-gray-400 truncate">${fileInput.files[0].name}</p>
              `;
                historyDiv.appendChild(newImage);
              };
              reader.readAsDataURL(fileInput.files[0]);

              // Show loading animation in both preview and code views
              const previewContent = document.getElementById("previewContent");
              const codeContent = document.getElementById("codeContent");
              const codeElement = codeContent.querySelector("code");

              previewContent.innerHTML = loadingAnimation;
              codeElement.innerHTML = loadingAnimation;

              // Create FormData and append the file
              const formData = new FormData();
              formData.append("image", fileInput.files[0]);

              try {
                // Make API request
                const response = await fetch(
                  "http://localhost:3000/api/generate",
                  {
                    method: "POST",
                    body: formData,
                  }
                );

                const data = await response.json();

                // Extract HTML code from the response
                const htmlCode = data.response.match(
                  /```html\n([\s\S]*?)\n```/
                )[1];

                // Update code view with syntax highlighting
                codeElement.textContent = htmlCode;
                codeElement.className = "language-html";
                Prism.highlightElement(codeElement);

                // Update preview iframe
                const iframe = document.createElement("iframe");
                iframe.style.width = "100%";
                iframe.style.height = "500px";
                iframe.style.border = "none";
                iframe.style.backgroundColor = "white";
                previewContent.innerHTML = ""; // Clear existing content
                previewContent.appendChild(iframe);

                // Write the code to the iframe with default white background
                iframe.contentDocument.open();
                iframe.contentDocument.write(`
                <style>
                  body { 
                    margin: 0; 
                    background: white;
                  }
                </style>
                ${htmlCode}
              `);
                iframe.contentDocument.close();

                // Update sampleCode variable for "Open in new tab" functionality
                window.sampleCode = `
                <style>
                  body { 
                    margin: 0; 
                    background: white;
                  }
                </style>
                ${htmlCode}
              `;

                // Enable the send button and input after image is uploaded
                document.getElementById("sendButton").disabled = false;
                document.getElementById("messageInput").disabled = false;
              } catch (error) {
                console.error("Error:", error);
                // Handle error appropriately
              }
            }
          });
        // Preview image on file select
        document
          .getElementById("fileInput")
          .addEventListener("change", function (e) {
            if (this.files && this.files[0]) {
              // Show image preview and side-by-side layout
              const uploadContainer =
                document.getElementById("uploadContainer");
              const previewContainer =
                document.getElementById("previewContainer");

              uploadContainer.classList.add("hidden");
              previewContainer.classList.remove("hidden");

              // Show image preview
              const reader = new FileReader();
              reader.onload = function (e) {
                const imagePreview = document.getElementById("imagePreview");
                imagePreview.src = e.target.result;
              };
              reader.readAsDataURL(this.files[0]);

              // Enable analyze button
              document.getElementById("analyzeButton").disabled = false;
            }
          });

        // Handle sending messages
        document
          .getElementById("sendButton")
          .addEventListener("click", sendMessage);
        document
          .getElementById("messageInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              sendMessage();
            }
          });

        // First, add a function to store responses in sessionStorage
        function storeInSession(imageId, data) {
          const sessionData = {
            code: data.code,
            imageUrl: data.imageUrl,
            timestamp: new Date().toISOString(),
          };
          sessionStorage.setItem(
            `response_${imageId}`,
            JSON.stringify(sessionData)
          );
        }

        // Modify the getTruncatedCode function to show first 5 lines
        function getTruncatedCode(code) {
          if (!code) return "";
          const cleanCode = code.replace(/```html\n|```/g, "").trim();
          const lines = cleanCode.split("\n");
          const firstFiveLines = lines.slice(0, 5).join("\n");
          return firstFiveLines + (lines.length > 5 ? "\n..." : "");
        }

        // Modify the sendMessage function's response handling
        async function sendMessage() {
          const messageInput = document.getElementById("messageInput");
          const message = messageInput.value.trim();
          const historyDiv = document.getElementById("imageHistory");

          if (message) {
            // Create and append user message immediately
            const messageElement = document.createElement("div");
            messageElement.className = "";
            messageElement.innerHTML = `
              <div class="flex flex-col space-y-2">
                <div class="flex justify-end">
                  <div class="bg-gray-600 text-white rounded-2xl py-0.5 px-3 max-w-[80%]" data-role="user" data-type="text">
                    <p class="text-sm">${message}</p>
                  </div>
                </div>
                <div class="flex justify-start" id="ai-response-loading">
                  <div class="bg-gray-700/50 backdrop-blur-sm text-gray-100 rounded-2xl py-0.5 px-3 max-w-[80%]">
                    <p class="text-sm">Thinking...</p>
                  </div>
                </div>
              </div>
            `;
            historyDiv.appendChild(messageElement);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            // Collect all messages from chat history
            const historyMessages = Array.from(historyDiv.children)
              .map((el) => {
                const userMsg = el.querySelector('[data-role="user"]');
                const aiMsg = el.querySelector('[data-role="assistant"]');
                const messages = [];

                if (userMsg) {
                  messages.push({
                    role: "user",
                    type: userMsg.dataset.type || "text",
                    content: userMsg.querySelector(".text-sm").textContent,
                  });
                }
                if (
                  aiMsg &&
                  !aiMsg
                    .querySelector(".text-sm")
                    .textContent.includes("Thinking...")
                ) {
                  messages.push({
                    role: "assistant",
                    type: "text",
                    content: aiMsg.querySelector(".text-sm").textContent,
                  });
                }
                return messages;
              })
              .flat();

            // Add the current code if it exists
            const currentCode =
              document.querySelector("#codeContent code")?.textContent;
            if (currentCode) {
              historyMessages.push({
                role: "assistant",
                type: "code",
                content: currentCode,
              });
            }

            // Clear input after sending
            messageInput.value = "";

            try {
              const response = await fetch(
                "http://localhost:3000/api/generate",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    message: message,
                    history: JSON.stringify(historyMessages),
                  }),
                }
              );

              const data = await response.json();
              const responseId = Date.now().toString();

              // Store response in sessionStorage
              storeInSession(responseId, {
                code: data.response,
                timestamp: new Date().toISOString(),
              });

              // Update AI response in chat with first 5 lines of code
              const loadingResponse = messageElement.querySelector(
                "#ai-response-loading"
              );
              const truncatedCode = getTruncatedCode(data.response);

              loadingResponse.innerHTML = `
                <div class="bg-gray-700/50 backdrop-blur-sm text-gray-100 rounded-lg py-0.5 px-1 max-w-[80%]" data-role="assistant" data-response-id="${responseId}">
                  <div class="flex items-center justify-between cursor-pointer hover:bg-gray-600/50 p-2 rounded transition-colors" onclick="showHistoricalResponse('${responseId}', true)">
                    <p class="text-sm">Code generated</p>
                    <svg class="w-4 h-4 text-gray-400 hover:text-blue-400 transition-colors ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 3L3 21M21 3h-8M21 3v8M3 21h8M3 21v-8"/>
                    </svg>
                  </div>
                </div>
              `;

              // Update the output area with the latest code
              const codeElement = document.querySelector("#codeContent code");
              const cleanCode = data.response.replace(/```html\n|```/g, "");
              codeElement.textContent = cleanCode;
              codeElement.className = "language-html";
              Prism.highlightElement(codeElement);

              // Show code view and update preview
              document.getElementById("codeContent").classList.remove("hidden");
              document.getElementById("previewContent").classList.add("hidden");
              updatePreviewIframe(cleanCode);

              // Store the latest response ID
              sessionStorage.setItem("lastResponseId", responseId);
            } catch (error) {
              console.error("Error:", error);
              const loadingResponse = messageElement.querySelector(
                "#ai-response-loading"
              );
              loadingResponse.innerHTML = `
                <div class="bg-gray-500/50 backdrop-blur-sm text-white rounded-lg py-1.5 px-3 max-w-[80%]">
                  <p class="text-sm">Sorry, there was an error processing your request.</p>
                </div>
              `;
            }

            // Scroll to bottom after response
            historyDiv.scrollTop = historyDiv.scrollHeight;
          }
        }

        // Helper function to update preview iframe
        function updatePreviewIframe(htmlCode) {
          const previewContent = document.getElementById("previewContent");
          const iframe = document.createElement("iframe");
          iframe.style.width = "100%";
          iframe.style.height = "500px";
          iframe.style.border = "none";
          iframe.style.backgroundColor = "white";
          previewContent.innerHTML = "";
          previewContent.appendChild(iframe);

          iframe.contentDocument.open();
          iframe.contentDocument.write(`
            <style>
              body { 
                margin: 0; 
                background: white;
              }
            </style>
            ${htmlCode}
          `);
          iframe.contentDocument.close();

          // Update sampleCode variable for "Open in new tab" functionality
          window.sampleCode = htmlCode;
        }

        // Handle new image upload button
        document
          .getElementById("newImageButton")
          .addEventListener("click", function () {
            document.getElementById("newFileInput").click();
          });

        document
          .getElementById("newFileInput")
          .addEventListener("change", async function (e) {
            if (this.files && this.files[0]) {
              const reader = new FileReader();
              reader.onload = async function (e) {
                const historyDiv = document.getElementById("imageHistory");

                // Create and append the image message
                const messageElement = document.createElement("div");

                messageElement.innerHTML = `
                  <div class="flex flex-col  space-y-2">
                    <div class="flex mb-3 justify-end">
                      <div class="bg-gray-500 text-white rounded-lg py-2 px-4 max-w-[80%]" data-role="user" data-type="image">
                        <img src="${e.target.result}" alt="Uploaded image" class="max-h-48 rounded-lg mb-2">
                        <p class="text-sm">New image uploaded</p>
                      </div>
                    </div>
                    <div class="flex justify-start" id="ai-response-loading">
                      <div class="bg-gray-700 text-gray-100 rounded-lg py-2 px-4 max-w-[80%]">
                        <p class="text-sm">Generating UI code...</p>
                      </div>
                    </div>
                  </div>
                `;
                historyDiv.appendChild(messageElement);
                historyDiv.scrollTop = historyDiv.scrollHeight;

                // Collect all messages from chat history
                const historyMessages = Array.from(historyDiv.children)
                  .map((el) => {
                    const userMsg = el.querySelector('[data-role="user"]');
                    const aiMsg = el.querySelector('[data-role="assistant"]');
                    const messages = [];

                    if (userMsg) {
                      messages.push({
                        role: "user",
                        type: userMsg.dataset.type || "text",
                        content: userMsg.querySelector(".text-sm").textContent,
                      });
                    }
                    if (
                      aiMsg &&
                      !aiMsg
                        .querySelector(".text-sm")
                        .textContent.includes("Generating UI code...")
                    ) {
                      messages.push({
                        role: "assistant",
                        type: "text",
                        content: aiMsg.querySelector(".text-sm").textContent,
                      });
                    }
                    return messages;
                  })
                  .flat();

                // Create FormData and append the file and history
                const formData = new FormData();
                formData.append("image", this.files[0]);
                formData.append("history", JSON.stringify(historyMessages));

                try {
                  // Show loading state
                  const codeElement =
                    document.querySelector("#codeContent code");
                  codeElement.innerHTML = loadingAnimation;
                  document
                    .getElementById("codeContent")
                    .classList.remove("hidden");
                  document
                    .getElementById("previewContent")
                    .classList.add("hidden");

                  // Make API request
                  const response = await fetch(
                    "http://localhost:3000/api/generate",
                    {
                      method: "POST",
                      body: formData,
                    }
                  );

                  const data = await response.json();
                  const responseId = Date.now().toString();

                  // Store response and image in sessionStorage
                  storeInSession(responseId, {
                    code: data.response,
                    imageUrl: e.target.result,
                    timestamp: new Date().toISOString(),
                  });

                  // Update AI response with first 5 lines of code
                  const loadingResponse = messageElement.querySelector(
                    "#ai-response-loading"
                  );
                  const truncatedCode = getTruncatedCode(data.response);

                  loadingResponse.innerHTML = `
                    <div class="bg-gray-700/50 backdrop-blur-sm text-gray-100 rounded-lg py-1.5 px-1 max-w-[80%]" data-role="assistant" data-response-id="${responseId}">
                      <div class="flex items-center justify-between cursor-pointer hover:bg-gray-600/50 p-2 rounded transition-colors" onclick="showHistoricalResponse('${responseId}', true)">
                        <p class="text-sm">Code generated</p>
                        <svg class="w-4 h-4 text-gray-400 hover:text-blue-400 transition-colors ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 3L3 21M21 3h-8M21 3v8M3 21h8M3 21v-8"/>
                        </svg>
                      </div>
                    </div>
                  `;

                  // Update the output area with the latest code
                  const cleanCode = data.response.replace(/```html\n|```/g, "");
                  codeElement.textContent = cleanCode;
                  codeElement.className = "language-html";
                  Prism.highlightElement(codeElement);

                  // Show code view and update preview
                  document
                    .getElementById("codeContent")
                    .classList.remove("hidden");
                  document
                    .getElementById("previewContent")
                    .classList.add("hidden");
                  updatePreviewIframe(cleanCode);

                  // Store the latest response ID
                  sessionStorage.setItem("lastResponseId", responseId);
                } catch (error) {
                  console.error("Error:", error);
                  const loadingResponse = messageElement.querySelector(
                    "#ai-response-loading"
                  );
                  loadingResponse.innerHTML = `
                    <div class="bg-gray-500/50 backdrop-blur-sm text-white rounded-lg py-1.5 px-3 max-w-[80%]">
                      <p class="text-sm">Sorry, there was an error generating the UI code.</p>
                    </div>
                  `;
                }
              }.bind(this);
              reader.readAsDataURL(this.files[0]);
            }
          });

        const previewButton = document.getElementById("previewButton");
        const codeButton = document.getElementById("codeButton");
        const newTabButton = document.getElementById("newTabButton");
        const previewContent = document.getElementById("previewContent");
        const codeContent = document.getElementById("codeContent");
        const codeElement = codeContent.querySelector("code");

        // Replace the loadingAnimation constant with this new version
        const loadingAnimation = `
<div class="flex flex-col items-center justify-center min-h-[500px]  backdrop-blur-sm">
  <!-- Ripple loading container -->
  <div class="loader-container absolute inset-0 flex items-center justify-center">
    <div class="ripple"></div>
  </div>
  
  <!-- Loading text -->
  <div class="absolute bottom-10 left-1/2 -translate-x-1/2 text-center">
    <h3 class="text-lg font-medium !text-gray-200">
      Generating Code...
    </h3>
  </div>
</div>

<style>
  .loader-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    width: 100%;
  }

  .ripple {
    position: relative;
    width: 50px;
    height: 50px;
  }

  .ripple::before, .ripple::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 4px solid #3B82F6;
    opacity: 0;
    animation: ripple 3s infinite;
  }

  .ripple::after {
    animation-delay: 1.5s;
  }

  @keyframes ripple {
    0% {
      transform: scale(0.5);
      opacity: 0;
    }
    25% {
      opacity: 0.6;
    }
    100% {
      transform: scale(2.5);
      opacity: 0;
    }
  }
</style>
`;

        // Show loading animation in code view by default
        codeContent.classList.remove("hidden");
        previewContent.classList.add("hidden");
        codeElement.innerHTML = loadingAnimation;

        previewButton.addEventListener("click", () => {
          previewContent.classList.remove("hidden");
          codeContent.classList.add("hidden");

          // Create iframe for preview if it doesn't exist
          if (!previewContent.querySelector("iframe")) {
            const iframe = document.createElement("iframe");
            iframe.style.width = "100%";
            iframe.style.height = "500px";
            iframe.style.border = "none";
            iframe.style.backgroundColor = "white";
            previewContent.appendChild(iframe);

            // Write the loading animation to the iframe
            iframe.contentDocument.open();
            iframe.contentDocument.write(`
            <style>
              body { 
                margin: 0; 
                background: white;
              }
            </style>
            ${loadingAnimation}
          `);
            iframe.contentDocument.close();
          }
        });

        codeButton.addEventListener("click", () => {
          previewContent.classList.add("hidden");
          codeContent.classList.remove("hidden");
        });

        newTabButton.addEventListener("click", () => {
          const newWindow = window.open();
          newWindow.document.write(`
          <style>
            body { margin: 0; }
          </style>
          ${window.sampleCode || loadingAnimation}
        `);
          newWindow.document.close();
        });

        // Update showHistoricalResponse to always show the clicked response
        function showHistoricalResponse(responseId, keepLatest = false) {
          const sessionData = JSON.parse(
            sessionStorage.getItem(`response_${responseId}`)
          );
          if (!sessionData) return;

          // Remove the keepLatest check so it always shows the clicked response
          const codeElement = document.querySelector("#codeContent code");
          const cleanCode = sessionData.code.replace(/```html\n|```/g, "");
          codeElement.textContent = cleanCode;
          codeElement.className = "language-html";
          Prism.highlightElement(codeElement);

          // Show code view and update preview
          document.getElementById("codeContent").classList.remove("hidden");
          document.getElementById("previewContent").classList.add("hidden");
          updatePreviewIframe(cleanCode);

          // If there's an image, update the preview
          if (sessionData.imageUrl) {
            const imagePreview = document.getElementById("imagePreview");
            if (imagePreview) {
              imagePreview.src = sessionData.imageUrl;
            }
          }
        }

        // Add this to your window load event or initialization code
        window.addEventListener("load", () => {
          // Restore last session state if exists
          const lastResponseId = sessionStorage.getItem("lastResponseId");
          if (lastResponseId) {
            showHistoricalResponse(lastResponseId);
          }
        });

        // Copy button functionality
        document
          .getElementById("copyButton")
          .addEventListener("click", async () => {
            const codeElement = document.querySelector("#codeContent code");
            const textToCopy = codeElement.textContent;

            try {
              await navigator.clipboard.writeText(textToCopy);

              // Visual feedback
              const copyButton = document.getElementById("copyButton");
              const originalContent = copyButton.innerHTML;
              copyButton.innerHTML = `
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              Copied!
            `;

              // Reset button after 2 seconds
              setTimeout(() => {
                copyButton.innerHTML = originalContent;
              }, 2000);
            } catch (err) {
              console.error("Failed to copy text:", err);
            }
          });
      </script>

      <style>
        /* Custom scrollbar styling */
        .scrollbar-custom::-webkit-scrollbar {
          width: 8px;
        }

        .scrollbar-custom::-webkit-scrollbar-track {
          background: #1f2937; /* gray-800 */
          border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb {
          background: #4b5563; /* gray-600 */
          border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
          background: #6b7280; /* gray-500 */
        }

        /* Firefox scrollbar styling */
        .scrollbar-custom {
          scrollbar-width: thin;
          scrollbar-color: #4b5563 #1f2937;
        }

        @keyframes bounce {
          0%,
          100% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(-4px);
          }
        }

        @keyframes spin {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }

        @keyframes pulse {
          0%,
          100% {
            transform: scale(1);
            opacity: 0.5;
          }
          50% {
            transform: scale(1.1);
            opacity: 0.8;
          }
        }
      </style>
    </div>
  </body>
</html>
